name: Mirror modules go get check

on:
  # Runs on PRs where mirrors and/or operators.yaml changed
  pull_request:
    branches:
      - main
    paths:
      - 'operators.yaml'
      - 'mirrors/**'

jobs:
  discover-modules:
    name: Discover mirrored modules
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Build matrix from operators.yaml
        id: set-matrix
        run: |          
          modules=$(yq -o=json '.operators[] | .slug + "/" + .currentVersion' operators.yaml | jq -s .)  
          echo "Modules: $modules"
          echo "matrix={\"module\":$modules}" >> "$GITHUB_OUTPUT"

  go-get-test:
    name: go get ${{ matrix.module }}
    needs: discover-modules
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-modules.outputs.matrix) }}

    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: go get module
        env:
          MOD_ROOT: github.com/sourcehawk/operator-api-mirror
          COMMIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          MODULE_PATH="${MOD_ROOT}/${{ matrix.module }}"
          VERSIONED="${MODULE_PATH}@${COMMIT_SHA}"

          echo "Testing go get for: ${VERSIONED}"

          # Create a throwaway module
          mkdir -p /tmp/mirror-go-get-test
          cd /tmp/mirror-go-get-test
          go mod init mirror-go-get-test
          go get "${VERSIONED}"
